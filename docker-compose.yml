version: "3.8"
services:
  wireguard_with_gui:
    image: wg-easy-with-metrics
    container_name: wireguard_with_gui
    ports:
      - "51820:51820/udp"
      - "51821:51821"
    restart: unless-stopped
    hostname: wireguard
    user: root
    environment:
      - WG_HOST=${WGEASY_SERVER_HOST:-192.168.0.10}
      - PASSWORD=${WGEASY_ADMIN_PASSWORD:-p123123}
      - WG_PORT=${WGEASY_PORT:-51820}
      - WG_PERSISTENT_KEEPALIVE=30
      - WG_DEFAULT_DNS=${WGEASY_DNS:-1.1.1.1}
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    volumes:
      - ./wireguard:/etc/wireguard
      #To use this volume, you should create folder ./logs and make permissions 777 to it
      #- ./logs/:/var/log/

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus:/etc/prometheus/
      - ./prometheus_data:/prometheus
    container_name: prometheus
    hostname: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=180d'
      - '--web.enable-lifecycle'
    #No need to open port of prometheus. It used internally by Grafana without auth.
    #ports:
    #  - 9090:9090
    restart: unless-stopped
    environment:
      TZ: "Europe/Moscow"

  grafana:
    image: grafana/grafana
    user: root
    depends_on:
      - prometheus
    ports:
      - 3000:3000
    volumes:
      - ./grafana_data:/var/lib/grafana
      - ./grafana/provisioning/:/etc/grafana/provisioning/
    container_name: grafana
    hostname: grafana
    restart: unless-stopped
    environment:
      - TZ="Europe/Moscow"
      - GF_SECURITY_ADMIN_USER=${WGEASY_GRAFANA_ADMIN_USERNAME:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${WGEASY_GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
